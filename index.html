<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý ảo Mít</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }
        body {
            overflow: hidden;
            background: radial-gradient(circle, #1a1a2e 0%, #0f0f1a 100%);
            color: white;
            transition: background 0.8s ease;
        }
        #canvas-container {
            width: 100vw;
            height: 65vh;
            overflow: hidden;
            position: relative;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        .chat-container {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 35vh;
            background: rgba(15, 15, 30, 0.85);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            overflow-y: auto;
            transition: height 0.3s ease;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        .chat-message {
            margin: 12px 0;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            line-height: 1.4;
            word-break: break-word;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-message {
            background: linear-gradient(135deg, #4CAF50, #3d9440);
            color: white;
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 4px;
        }
        .assistant-message {
            background: linear-gradient(135deg, #2979FF, #1565C0);
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            z-index: 10;
        }
        .controls button {
            padding: 10px 20px;
            background: rgba(33, 150, 243, 0.8);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .controls button:hover {
            background: rgba(33, 150, 243, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
        .controls button:active {
            transform: translateY(1px);
        }
        .theme-selector {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }
        .theme-selector select {
            padding: 10px 16px;
            border-radius: 50px;
            background: rgba(33, 150, 243, 0.8);
            color: white;
            border: none;
            cursor: pointer;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            appearance: none;
            -webkit-appearance: none;
            padding-right: 30px;
            font-weight: 500;
        }
        .theme-selector select:hover {
            background: rgba(33, 150, 243, 1);
            transform: translateY(-2px);
        }
        .theme-selector select:focus {
            outline: none;
        }
        .theme-selector::after {
            content: '▼';
            font-size: 12px;
            color: white;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        #micBtn.active {
            background: rgba(244, 67, 54, 0.8);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }
        .status-indicator {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        .status-indicator.visible {
            opacity: 1;
        }
        #settingsModal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: linear-gradient(135deg, #2a2a42, #1a1a2e);
            border-radius: 15px;
            margin: 10% auto;
            padding: 25px;
            width: 80%;
            max-width: 500px;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s;
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-content h2 {
            margin-bottom: 20px;
            font-weight: 500;
            color: #64ffda;
            border-bottom: 1px solid rgba(100, 255, 218, 0.3);
            padding-bottom: 10px;
        }
        .form-group {
            margin: 20px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2);
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 25px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        .modal-buttons button.save {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }
        .modal-buttons button.close {
            background: linear-gradient(135deg, #f44336, #C62828);
        }
        .modal-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* Speed slider modal */
        #speedModal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }
        .speed-slider-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
        }
        .speed-value {
            width: 60px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-left: 15px;
            color: #64ffda;
        }
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #64ffda;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #64ffda;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            border: none;
        }

        /* Robot styles */
        #robot-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 380px;
        }

        /* Star background */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
        }

        /* Robot parts */
        .robot-head {
            position: absolute;
            width: 160px;
            height: 160px;
            background: linear-gradient(135deg, #4285F4, #34A853);
            border-radius: 50%;
            top: 0;
            left: calc(50% - 80px);
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .robot-face {
            position: absolute;
            width: 130px;
            height: 130px;
            background: #ffffff;
            border-radius: 50%;
            top: 15px;
            left: 15px;
        }

        .robot-eye {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #333;
            border-radius: 50%;
            top: 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2) inset;
            transition: all 0.3s;
        }

        .robot-eye::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            top: 5px;
            left: 5px;
        }

        .robot-eye.left {
            left: 35px;
        }

        .robot-eye.right {
            right: 35px;
        }

        .robot-mouth {
            position: absolute;
            width: 60px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            bottom: 35px;
            left: calc(50% - 30px);
            transition: all 0.3s;
            overflow: hidden;
        }

        .robot-mouth-inner {
            position: absolute;
            width: 60px;
            height: 10px;
            background: #FF5252;
            bottom: 0;
            border-radius: 10px 10px 0 0;
        }

        .robot-body {
            position: absolute;
            width: 180px;
            height: 200px;
            background: linear-gradient(135deg, #4285F4, #34A853);
            border-radius: 40px;
            top: 140px;
            left: calc(50% - 90px);
            z-index: 9;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .robot-panel {
            position: absolute;
            width: 120px;
            height: 140px;
            background: rgba(255,255,255,0.8);
            border-radius: 20px;
            top: 30px;
            left: calc(50% - 60px);
        }

        .robot-button {
            position: absolute;
            width: 15px;
            height: 15px;
            background: #FF5252;
            border-radius: 50%;
            top: 15px;
        }

        .robot-button:nth-child(1) {
            left: 30px;
            background: #FF5252;
        }

        .robot-button:nth-child(2) {
            left: 60px;
            background: #FFEB3B;
        }

        .robot-button:nth-child(3) {
            left: 90px;
            background: #4CAF50;
        }

        .robot-indicator {
            position: absolute;
            width: 80px;
            height: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            top: 40px;
            left: calc(50% - 40px);
            overflow: hidden;
        }

        .robot-indicator::after {
            content: '';
            position: absolute;
            height: 100%;
            border-radius: 5px;
            background: #4285F4;
            animation: indicatorPulse 2s infinite;
        }

        @keyframes indicatorPulse {
            0% { width: 0%; left: 0; }
            50% { width: 30%; left: 70%; }
            100% { width: 0%; left: 100%; }
        }

        .robot-arm {
            position: absolute;
            width: 30px;
            background: linear-gradient(135deg, #4285F4, #34A853);
            border-radius: 15px;
            z-index: 8;
        }

        .robot-arm.left {
            height: 120px;
            left: 15px;
            top: 180px;
            transform-origin: top center;
            transform: rotate(15deg);
            transition: transform 0.5s;
        }

        .robot-arm.right {
            height: 120px;
            right: 15px;
            top: 180px;
            transform-origin: top center;
            transform: rotate(-15deg);
            transition: transform 0.5s;
        }

        .robot-hand {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #fff;
            border-radius: 20px;
            bottom: -20px;
            left: -5px;
        }

        .robot-leg {
            position: absolute;
            width: 35px;
            height: 100px;
            background: linear-gradient(135deg, #4285F4, #34A853);
            border-radius: 20px;
            top: 320px;
            z-index: 7;
        }

        .robot-leg.left {
            left: 70px;
            transform-origin: top center;
            transition: transform 0.5s;
        }

        .robot-leg.right {
            right: 70px;
            transform-origin: top center;
            transition: transform 0.5s;
        }

        .robot-foot {
            position: absolute;
            width: 50px;
            height: 20px;
            background: #fff;
            border-radius: 10px;
            bottom: -10px;
            left: -8px;
        }

        .robot-antenna {
            position: absolute;
            width: 8px;
            height: 30px;
            background: linear-gradient(to top, #4285F4, #34A853);
            border-radius: 4px;
            top: -25px;
            left: calc(50% - 4px);
        }

        .robot-antenna::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #FFEB3B;
            border-radius: 50%;
            top: -10px;
            left: -4px;
            animation: glow 1.5s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px #FFEB3B; }
            to { box-shadow: 0 0 20px #FFEB3B; }
        }

        /* Robot animations */
        @keyframes talking {
            0%, 100% { height: 20px; border-radius: 10px; }
            50% { height: 30px; border-radius: 15px; }
        }

        @keyframes smiling {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5) scaleX(1.2); }
        }

        @keyframes waving {
            0%, 100% { transform: rotate(-15deg); }
            50% { transform: rotate(-45deg); }
        }

        @keyframes dancing {
            0% { transform: translateY(0) rotate(0); }
            25% { transform: translateY(-15px) rotate(5deg); }
            50% { transform: translateY(0) rotate(0); }
            75% { transform: translateY(-15px) rotate(-5deg); }
            100% { transform: translateY(0) rotate(0); }
        }

        @keyframes surprised {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        /* Stars background animation */
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        @keyframes floatUp {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100vh); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .controls {
                top: 10px;
                right: 10px;
                flex-direction: column;
            }
            
            .controls button {
                padding: 8px 15px;
                font-size: 14px;
            }
            
            .theme-selector {
                top: 10px;
                left: 10px;
            }
            
            .theme-selector select {
                padding: 8px 15px;
                font-size: 14px;
            }

            #robot-container {
                width: 220px;
                height: 320px;
            }
        }

        @media (max-width: 480px) {
            #robot-container {
                width: 180px;
                height: 280px;
            }

            .controls button {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <div id="robot-container">
            <div class="robot-head">
                <div class="robot-face">
                    <div class="robot-eye left"></div>
                    <div class="robot-eye right"></div>
                    <div class="robot-mouth">
                        <div class="robot-mouth-inner"></div>
                    </div>
                    <div class="robot-antenna"></div>
                </div>
            </div>
            <div class="robot-body">
                <div class="robot-panel">
                    <div class="robot-button"></div>
                    <div class="robot-button"></div>
                    <div class="robot-button"></div>
                    <div class="robot-indicator"></div>
                </div>
            </div>
            <div class="robot-arm left">
                <div class="robot-hand"></div>
            </div>
            <div class="robot-arm right">
                <div class="robot-hand"></div>
            </div>
            <div class="robot-leg left">
                <div class="robot-foot"></div>
            </div>
            <div class="robot-leg right">
                <div class="robot-foot"></div>
            </div>
        </div>
    </div>
    
    <div class="status-indicator" id="statusIndicator">Đang lắng nghe...</div>
    <div class="controls">
        <button id="micBtn">🎤 Bật Micro</button>
        <button id="speedBtn">🔊 Tốc độ</button>
        <button id="clearChatBtn">🗑️ Xóa Chat</button>
        <button id="settingsBtn">⚙️ Cài đặt</button>
    </div>
    <div class="theme-selector">
        <select id="themeSelect">
            <option value="space">🌌 Không gian</option>
            <option value="forest">🌲 Rừng</option>
            <option value="ocean">🌊 Đại dương</option>
            <option value="night">🌙 Đêm sao</option>
            <option value="tech">💻 Công nghệ</option>
        </select>
    </div>
    
    <div id="settingsModal">
        <div class="modal-content">
            <h2>Cài đặt</h2>
            <div class="form-group">
                <label for="apiUrlInput">URL API (Địa chỉ máy chủ xử lý):</label>
                <input type="text" id="apiUrlInput" placeholder="http://localhost:5000">
            </div>
            <div class="form-group">
                <label for="beepToggle">Âm thanh phản hồi:</label>
                <input type="checkbox" id="beepToggle" checked>
                <span>Bật tiếng beep khi bắt đầu và kết thúc lắng nghe</span>
            </div>
            <div class="modal-buttons">
                <button id="saveSettingsBtn" class="save">Lưu</button>
                <button id="closeSettingsBtn" class="close">Đóng</button>
            </div>
        </div>
    </div>
    
    <!-- Speed modal -->
    <div id="speedModal">
        <div class="modal-content">
            <h2>Điều chỉnh tốc độ nói</h2>
            <div class="form-group">
                <div class="speed-slider-container">
                    <input type="range" min="0.5" max="2" step="0.1" value="1" class="slider" id="speedSlider">
                    <span class="speed-value" id="speedValue">1.0</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="saveSpeedBtn" class="save">Lưu</button>
                <button id="closeSpeedBtn" class="close">Đóng</button>
            </div>
        </div>
    </div>
    
    <div class="chat-container" id="chatContainer"></div>

    <script>
        // Global variables
        let isListening = false;
        let recognition;
        let speechSynthesis = window.speechSynthesis;
        let beepSound = new Audio('audio/beep.mp3');
        let errorSound = new Audio('audio/error.mp3');
        let currentAnimation = null;
        
        // API URL from localStorage or default
        let apiUrl = localStorage.getItem('mitApiUrl') || 'http://localhost:5000';
        
        // Speech rate
        let speechRate = localStorage.getItem('speechRate') || 1.0;
        
        // Beep sound setting
        let useBeepSound = localStorage.getItem('useBeepSound') !== 'false'; // Default to true
        
        // DOM elements
        const robotHead = document.querySelector('.robot-head');
        const robotFace = document.querySelector('.robot-face');
        const robotMouth = document.querySelector('.robot-mouth');
        const robotEyeLeft = document.querySelector('.robot-eye.left');
        const robotEyeRight = document.querySelector('.robot-eye.right');
        const robotArmLeft = document.querySelector('.robot-arm.left');
        const robotArmRight = document.querySelector('.robot-arm.right');
        const robotLegLeft = document.querySelector('.robot-leg.left');
        const robotLegRight = document.querySelector('.robot-leg.right');
        const robotBody = document.querySelector('.robot-body');
        
        // Create stars for the background
        function createStars() {
            const container = document.getElementById('canvas-container');
            const containerRect = container.getBoundingClientRect();
            
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // Random size between 1px and 3px
                const size = Math.random() * 2 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                
                // Random position
                star.style.left = `${Math.random() * containerRect.width}px`;
                star.style.top = `${Math.random() * containerRect.height}px`;
                
                // Random opacity
                star.style.opacity = Math.random() * 0.7 + 0.3;
                
                // Add twinkle animation with random delay
                star.style.animation = `twinkle ${Math.random() * 3 + 2}s infinite ${Math.random() * 5}s`;
                
                container.appendChild(star);
            }
            
            // Add floating particles
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.classList.add('star');
                
                // Smaller size for particles
                const size = Math.random() + 0.5;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                // Random position
                particle.style.left = `${Math.random() * containerRect.width}px`;
                particle.style.top = `${Math.random() * containerRect.height}px`;
                
                // Lower opacity
                particle.style.opacity = Math.random() * 0.3 + 0.1;
                
                // Add floating animation
                const duration = Math.random() * 60 + 30;
                particle.style.animation = `floatUp ${duration}s linear infinite`;
                
                container.appendChild(particle);
            }
        }
        
        // Create stars when page loads
        window.addEventListener('load', createStars);

        // Robot animations
        function startAnimation(type) {
            // Stop any current animation
            stopAnimation();
            
            // Set the current animation
            currentAnimation = type;
            
            switch(type) {
                case 'talking':
                    robotMouth.style.animation = 'talking 0.3s infinite';
                    break;
                case 'thinking':
                    robotEyeLeft.style.animation = 'thinking 1s infinite';
                    robotEyeRight.style.animation = 'thinking 1s infinite';
                    break;
                case 'listening':
                    robotEyeLeft.style.animation = 'surprised 1s infinite';
                    robotEyeRight.style.animation = 'surprised 1s infinite';
                    robotArmRight.style.animation = 'waving 2s infinite';
                    break;
                case 'happy':
                    robotMouth.style.animation = 'smiling 1s infinite';
                    break;
                case 'dancing':
                    robotBody.style.animation = 'dancing 2s infinite';
                    robotHead.style.animation = 'dancing 2s infinite reverse';
                    robotLegLeft.style.transform = 'rotate(5deg)';
                    robotLegRight.style.transform = 'rotate(-5deg)';
                    break;
            }
        }
        
        function stopAnimation() {
            currentAnimation = null;
            
            robotMouth.style.animation = '';
            robotEyeLeft.style.animation = '';
            robotEyeRight.style.animation = '';
            robotArmLeft.style.animation = '';
            robotArmRight.style.animation = '';
            robotBody.style.animation = '';
            robotHead.style.animation = '';
            robotLegLeft.style.transform = '';
            robotLegRight.style.transform = '';
        }
        
        // Send state to ESP8266 via API
        function updateLcdStatus(state) {
            fetch(`${apiUrl}/api/lcd_status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ state }),
            }).catch(error => console.error('Error updating LCD status:', error));
        }

        // Chat messages
        const chatContainer = document.getElementById('chatContainer');
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(isUser ? 'user-message' : 'assistant-message');
            messageDiv.textContent = content;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Speech recognition
        const micBtn = document.getElementById('micBtn');
        micBtn.addEventListener('click', toggleListening);
        
        if ('webkitSpeechRecognition' in window) {
            // Create speech recognition object
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'vi-VN';
            
            // Handle speech recognition results
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                addMessage(transcript, true);
                processCommand(transcript);
            };
            
            // Handle speech recognition errors
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    const statusIndicator = document.getElementById('statusIndicator');
                    statusIndicator.textContent = 'Không phát hiện giọng nói. Vui lòng thử lại.';
                    statusIndicator.classList.add('visible');
                    setTimeout(() => {
                        statusIndicator.classList.remove('visible');
                    }, 3000);
                }
                
                micBtn.textContent = '🎤 Bật Micro';
                micBtn.classList.remove('active');
                isListening = false;
                stopAnimation();
                
                // Play error sound
                errorSound.play();
            };
            
            // Handle speech recognition end
            recognition.onend = function() {
                micBtn.textContent = '🎤 Bật Micro';
                micBtn.classList.remove('active');
                isListening = false;
                stopAnimation();
            };
        } else {
            micBtn.textContent = '🎤 Không hỗ trợ';
            micBtn.disabled = true;
            addMessage("Trình duyệt của bạn không hỗ trợ nhận dạng giọng nói. Vui lòng sử dụng Chrome hoặc Edge.", false);
        }

        function toggleListening() {
            if (isListening) {
                recognition.stop();
                micBtn.textContent = '🎤 Bật Micro';
                micBtn.classList.remove('active');
                isListening = false;
                stopAnimation();
            } else {
                try {
                    recognition.start();
                    
                    // Play beep sound to indicate start of listening
                    if (useBeepSound) {
                        beepSound.play();
                    }
                    
                    micBtn.textContent = '🎤 Đang nghe...';
                    micBtn.classList.add('active');
                    isListening = true;
                    
                    const statusIndicator = document.getElementById('statusIndicator');
                    statusIndicator.textContent = 'Đang lắng nghe...';
                    statusIndicator.classList.add('visible');
                    setTimeout(() => {
                        statusIndicator.classList.remove('visible');
                    }, 3000);
                    
                    // Start listening animation
                    startAnimation('listening');
                    
                    // Send status to ESP8266
                    fetch(`${apiUrl}/api/status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ state: 'LISTENING' }),
                    }).catch(error => console.error('Error updating status:', error));
                    
                } catch (e) {
                    console.error('Error starting speech recognition:', e);
                }
            }
        }

        // Process command
        async function processCommand(text) {
            // Start thinking animation
            startAnimation('thinking');
            
            // Send status to ESP8266
            fetch(`${apiUrl}/api/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ state: 'PROCESSING' }),
            }).catch(error => console.error('Error updating status:', error));
            
            try {
                const response = await fetch(`${apiUrl}/api/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: text }),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                const data = await response.json();
                addMessage(data.response, false);
                
                // Play audio response
                speak(data.audio_url, data.response, determineAction(text, data.response));
                
            } catch (error) {
                console.error('Error processing command:', error);
                addMessage('Xin lỗi, tôi gặp lỗi khi xử lý yêu cầu của bạn. Vui lòng thử lại.', false);
                
                // Try fallback response using Web Speech API
                speakWithWebSpeechAPI('Xin lỗi, tôi gặp lỗi khi xử lý yêu cầu của bạn. Vui lòng thử lại.', 'sorry');
            }
        }

        // Determine robot action based on query and response
        function determineAction(query, response) {
            const query_lower = query.toLowerCase();
            const response_lower = response.toLowerCase();
            
            // Check for greeting or introduction
            if (query_lower.includes('xin chào') || query_lower.includes('chào bạn') || 
                query_lower.includes('hello') || query_lower.includes('hi') ||
                query_lower.includes('là ai') || query_lower.includes('tên gì')) {
                return 'happy';
            }
            
            // Check for music or entertainment related
            if (query_lower.includes('hát') || query_lower.includes('nhạc') || 
                query_lower.includes('bài hát') || query_lower.includes('vui')) {
                return 'dancing';
            }
            
            // Check for negative or error responses
            if (response_lower.includes('xin lỗi') || response_lower.includes('không thể') || 
                response_lower.includes('lỗi') || response_lower.includes('try again')) {
                return 'sorry';
            }
            
            // Default is talking animation
            return 'talking';
        }

        // Speech synthesis
        function speak(audioUrl, textContent, action) {
            // Start appropriate animation
            startAnimation(action);
            
            // Create audio element
            const audio = new Audio(audioUrl);
            
            // Play audio file from server
            audio.onloadedmetadata = function() {
                // Send status to ESP8266
                fetch(`${apiUrl}/api/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ state: 'ANSWERED' }),
                }).catch(error => console.error('Error updating status:', error));
                
                audio.play();
            };
            
            audio.onerror = function() {
                console.error('Error playing audio, falling back to Web Speech API');
                speakWithWebSpeechAPI(textContent, action);
            };
            
            audio.onended = function() {
                stopAnimation();
                
                // Play beep sound after response
                if (useBeepSound) {
                    beepSound.play();
                }
            };
        }
        
        // Web Speech API fallback
        function speakWithWebSpeechAPI(text, action) {
            if (!window.speechSynthesis) {
                console.error('Speech synthesis not supported');
                return;
            }
            
            // Send status to ESP8266
            fetch(`${apiUrl}/api/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ state: 'ANSWERED' }),
            }).catch(error => console.error('Error updating status:', error));
            
            // Start appropriate animation
            startAnimation(action);
            
            // Create speech synthesis utterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'vi-VN';
            utterance.rate = speechRate;
            
            // Find Vietnamese voice if available
            let vietnameseVoice = null;
            const voices = window.speechSynthesis.getVoices();
            for (const voice of voices) {
                if (voice.lang.includes('vi')) {
                    vietnameseVoice = voice;
                    break;
                }
            }
            
            if (vietnameseVoice) {
                utterance.voice = vietnameseVoice;
            }
            
            // Handle speech end
            utterance.onend = function() {
                stopAnimation();
                
                // Play beep sound after response
                if (useBeepSound) {
                    beepSound.play();
                }
            };
            
            // Speak
            window.speechSynthesis.speak(utterance);
        }

        // Clear chat history
        document.getElementById('clearChatBtn').addEventListener('click', () => {
            chatContainer.innerHTML = '';
        });

        // Theme selection
        document.getElementById('themeSelect').addEventListener('change', (e) => {
            const theme = e.target.value;
            const body = document.body;
            
            switch (theme) {
                case 'space':
                    body.style.background = 'radial-gradient(circle, #1a1a2e 0%, #0f0f1a 100%)';
                    break;
                case 'forest':
                    body.style.background = 'radial-gradient(circle, #2d6a4f 0%, #1b4332 100%)';
                    break;
                case 'ocean':
                    body.style.background = 'radial-gradient(circle, #1a508b 0%, #0b2545 100%)';
                    break;
                case 'night':
                    body.style.background = 'radial-gradient(circle, #2c3e50 0%, #1a1a2a 100%)';
                    break;
                case 'tech':
                    body.style.background = 'radial-gradient(circle, #3b4664 0%, #1d2030 100%)';
                    break;
            }
        });
        
        // Settings modal
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const apiUrlInput = document.getElementById('apiUrlInput');
        const beepToggle = document.getElementById('beepToggle');
        
        apiUrlInput.value = apiUrl;
        beepToggle.checked = useBeepSound;
        
        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'block';
        });
        
        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });
        
        saveSettingsBtn.addEventListener('click', () => {
            apiUrl = apiUrlInput.value;
            localStorage.setItem('mitApiUrl', apiUrl);
            
            useBeepSound = beepToggle.checked;
            localStorage.setItem('useBeepSound', useBeepSound);
            
            settingsModal.style.display = 'none';
            
            addMessage(`Đã cập nhật cài đặt. API URL: ${apiUrl}, Âm thanh beep: ${useBeepSound ? 'Bật' : 'Tắt'}`, false);
        });
        
        // Speed modal
        const speedBtn = document.getElementById('speedBtn');
        const speedModal = document.getElementById('speedModal');
        const closeSpeedBtn = document.getElementById('closeSpeedBtn');
        const saveSpeedBtn = document.getElementById('saveSpeedBtn');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        
        speedSlider.value = speechRate;
        speedValue.textContent = speechRate;
        
        speedBtn.addEventListener('click', () => {
            speedModal.style.display = 'block';
        });
        
        closeSpeedBtn.addEventListener('click', () => {
            speedModal.style.display = 'none';
        });
        
        saveSpeedBtn.addEventListener('click', () => {
            speechRate = speedSlider.value;
            localStorage.setItem('speechRate', speechRate);
            speedModal.style.display = 'none';
            
            addMessage(`Đã đặt tốc độ nói thành ${speechRate}x`, false);
        });
        
        speedSlider.addEventListener('input', () => {
            speedValue.textContent = speedSlider.value;
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            } else if (e.target === speedModal) {
                speedModal.style.display = 'none';
            }
        });
        
        // Initialize Web Speech API voices
        window.speechSynthesis.onvoiceschanged = () => {
            const voices = window.speechSynthesis.getVoices();
            console.log('Available voices:', voices.length);
        };
        
        // Welcome message
        window.addEventListener('load', () => {
            addMessage('Trợ lý ảo Mis đã sẵn sàng. Bạn có thể bắt đầu hỏi bằng cách nhấn nút "Bật Micro" hoặc nói "Hey Mis" trực tiếp nếu bạn đã kết nối module ESP8266 với KY-038.', false);
        });
    </script>
</body>
</html>